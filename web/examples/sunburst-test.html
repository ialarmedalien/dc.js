<!DOCTYPE html>
<html lang="en">
<head>
    <title>dc.js - Sunburst Chart Example</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../css/dc.css"/>
    <style>
        .pie-slice path {
            stroke:#fff;
        }
        .dc-chart .selected path {
            stroke-width: 1;
            stroke:#fff;
        }
    </style>
</head>
<body>

<div class="container">
<script type="text/javascript" src="header.js"></script>

<div id="test-content"></div>

<script type="text/javascript" src="../js/d3.js"></script>
<script type="text/javascript" src="../js/crossfilter.js"></script>
<script type="text/javascript" src="../js/dc.js"></script>
<script type="text/javascript">

function appendChartID (id) {
    return d3.select('#test-content').append('div').attr('id', id);
}

function dateCleaner (e) {
    e.dd = d3.isoParse(e.date);
}

function loadDateFixture () {
    var fixture = JSON.parse("[" +
        "{\"value\":\"44\",\"nvalue\":\"-4\",\"countrycode\":\"US\",\"state\":\"California\",\"status\":\"T\",\"id\":1,\"region\":\"South\",\"date\":\"2012-05-25T16:10:09Z\"}, " +
        "{\"value\":\"22\",\"nvalue\":\"-2\",\"countrycode\":\"US\",\"state\":\"Colorado\",\"status\":\"F\",\"id\":2,\"region\":\"West\",\"date\":\"2012-06-10T16:10:19Z\"}, " +
        "{\"value\":\"33\",\"nvalue\":\"1\",\"countrycode\":\"US\",\"state\":\"Delaware\",\"status\":\"T\",\"id\":3,\"region\":\"West\",\"date\":\"2012-08-10T16:20:29Z\"}, " +
        "{\"value\":\"44\",\"nvalue\":\"-3\",\"countrycode\":\"US\",\"state\":\"California\",\"status\":\"F\",\"id\":4,\"region\":\"South\",\"date\":\"2012-07-01T16:10:39Z\"}, " +
        "{\"value\":\"55\",\"nvalue\":\"-5\",\"countrycode\":\"CA\",\"state\":\"Ontario\",\"status\":\"T\",\"id\":5,\"region\":\"Central\",\"date\":\"2012-06-10T16:10:49Z\"}, " +
        "{\"value\":\"66\",\"nvalue\":\"-4\",\"countrycode\":\"US\",\"state\":\"California\",\"status\":\"F\",\"id\":6,\"region\":\"West\",\"date\":\"2012-06-08T16:10:59Z\"}, " +
        "{\"value\":\"22\",\"nvalue\":\"10\",\"countrycode\":\"CA\",\"state\":\"Ontario\",\"status\":\"T\",\"id\":7,\"region\":\"East\",\"date\":\"2012-07-10T16:10:09Z\"}, " +
        "{\"value\":\"33\",\"nvalue\":\"1\",\"countrycode\":\"US\",\"state\":\"Mississippi\",\"status\":\"F\",\"id\":8,\"region\":\"Central\",\"date\":\"2012-07-10T16:10:19Z\"}, " +
        "{\"value\":\"44\",\"nvalue\":\"2\",\"countrycode\":\"US\",\"state\":\"Mississippi\",\"status\":\"T\",\"id\":9,\"region\":\"Central\",\"date\":\"2012-08-10T16:30:29Z\"}, " +
        "{\"value\":\"55\",\"nvalue\":\"-3\",\"countrycode\":\"US\",\"state\":\"Oklahoma\",\"status\":\"F\",\"id\":10,\"region\":\"\",\"date\":\"2012-06-10T16:10:39Z\"}" +
        "]");

    fixture.forEach(dateCleaner);
    return fixture;
}

function buildChart (id) {
    var div = appendChartID(id);
    var ch = dc.partitionArc('#' + id);
//    div.append('a').attr('class', 'reset');
    div.append('p')
        .attr('class', 'filter');
    return ch;
}

var max = 5;
var i = 0;
var chart_arr = [];
while (i < max) {
  d3.select('#test-content')
    .append('div')
    .attr('id', 'test' + i )
    .classed('floatL', true)
    .append('p')
    .classed('filter', true);
  chart_arr.push( dc['partition' + ( i <= 3 ? 'Arc' : 'Rectangle' ) ]('#test' + i) );
  i++;
}


var width = 500;
var height = 500;
var radius = 100;
var innerRadius = 0;
var extRadPad = 0;
var extLabelPad = 0;
var drawPaths = false;
var legend;
var data, valueDimension, valueGroup;
var countryRegionStateDimension, countryRegionStateGroup;
var statusDimension;
var dateDimension;
var statusGroup, statusMultiGroup;
var arrValueDimension;

data = crossfilter(loadDateFixture());
valueDimension = data.dimension(function (d) {
    return d.value;
});
valueGroup = valueDimension.group();

arrValueDimension = data.dimension(function (d) {
    return [ d.value ];
});

countryRegionStateDimension = data.dimension(function (d) {
    return [d.countrycode, d.region, d.state];
});

statusDimension = data.dimension(function (d) {
    return d.status;
});

dateDimension = data.dimension(function (d) {
    return d3.utcDay(d.dd);
});

statusGroup = statusDimension.group();
statusMultiGroup = statusGroup.reduce(
    //add
    function (p, v) {
        ++p.count;
        p.value += +v.value;
        return p;
    },
    //remove
    function (p, v) {
        --p.count;
        p.value -= +v.value;
        return p;
    },
    //init
    function () {
        return {count: 0, value: 0};
    }
);

    chart_arr[0]
        .dimension(countryRegionStateDimension)
        .group(countryRegionStateDimension.group())
        .width(width)
        .height(height)
        .drawPaths(drawPaths);

    chart_arr[1]
        .dimension(valueDimension)
        .group(valueDimension.group().reduceCount())
//        .dimension(countryRegionStateDimension)
//         .group(countryRegionStateGroup)
        .width(width)
        .height(height)
        .externalLabels(50)
        .externalRadiusPadding(100)
        .drawPaths(true)
        .legend(dc.legend());

    chart_arr[2]
        .dimension(arrValueDimension)
        .group(arrValueDimension.group().reduceCount())
        .width(width)
        .height(height)
        .radius(radius)
        .transitionDuration(0)
        .externalLabels(10)
        .drawPaths(true)
        .render();

    chart_arr[3]
        .dimension(countryRegionStateDimension)
        .group(countryRegionStateDimension.group())
        .width(width)
        .height(height)
        .externalLabels(50)
        .externalRadiusPadding(100)
        .drawPaths(true)
        .legend(dc.legend());
//     statusDimension.filter('E');

    chart_arr[4]
        .dimension(countryRegionStateDimension)
        .group(countryRegionStateDimension.group())
        .width(width)
        .height(height)
        .transitionDuration(0);

    dc.renderAll();

    var dims = { width: {}, height: {}, n: 0 };
    d3.select('#test4').selectAll('.partition-slice rect').each(function(){
        var el = this;
        dims.n++;
        [ 'width', 'height' ].forEach( function(prop) {
            var val = Math.round( d3.select(this).attr(prop) );
            if ( ! dims[prop].hasOwnProperty( val ) ) {
                dims[prop][val] = 1;
            }
            else {
                dims[prop][val]++;
            }
        }, el );
    });
    console.log( dims );


</script>

</div>
</body>
</html>
